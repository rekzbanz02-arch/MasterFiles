<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Master File ¬∑ RekzBanz</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&family=Syne:wght@400;600;700;800&display=swap');

:root {
  --bg:#0a0c10; --surface:#111318; --surface2:#181c24; --surface3:#1e232e;
  --border:#252b38; --border-bright:#2e3749;
  --accent:#00e5ff; --accent2:#7c4dff; --accent3:#ff4081;
  --text:#e8eaf0; --text-muted:#6b7592; --text-dim:#9aa0b8;
  --success:#00e676; --warning:#ffea00; --danger:#ff1744;
  --radius:10px; --radius-sm:6px;
  --shadow:0 4px 24px rgba(0,0,0,0.5);
  --glow:0 0 20px rgba(0,229,255,0.15);
  --tr:0.25s cubic-bezier(0.4,0,0.2,1);
  --font-d:'Syne',sans-serif; --font-m:'Space Mono',monospace;
}
[data-theme="light"] {
  --bg:#f0f2f8; --surface:#fff; --surface2:#f5f7fc; --surface3:#eaecf5;
  --border:#d8dce8; --border-bright:#c5cade;
  --text:#1a1d2e; --text-muted:#8890b0; --text-dim:#5a6280;
  --shadow:0 4px 24px rgba(0,0,0,0.1); --glow:0 0 20px rgba(0,229,255,0.1);
}

*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{scroll-behavior:smooth}
body{font-family:var(--font-m);background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;transition:background var(--tr),color var(--tr)}
::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-track{background:var(--surface)}
::-webkit-scrollbar-thumb{background:var(--border-bright);border-radius:3px}

.hidden{display:none!important}
.w-full{width:100%}

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
#toast-container{position:fixed;top:20px;right:20px;z-index:9999;display:flex;flex-direction:column;gap:10px;pointer-events:none;max-width:300px}
.toast{font-family:var(--font-m);font-size:12px;padding:12px 18px;border-radius:var(--radius-sm);border-left:3px solid;background:var(--surface2);box-shadow:var(--shadow);opacity:0;transform:translateX(40px);word-break:break-word}
.toast.success{border-color:var(--success);color:var(--success)}
.toast.error{border-color:var(--danger);color:var(--danger)}
.toast.info{border-color:var(--accent);color:var(--accent)}
@keyframes toastIn{to{opacity:1;transform:translateX(0)}}
@keyframes toastOut{to{opacity:0;transform:translateX(40px)}}

/* ‚îÄ‚îÄ LOADING OVERLAY ‚îÄ‚îÄ */
#loading-overlay{position:fixed;inset:0;z-index:8888;background:var(--bg);display:flex;align-items:center;justify-content:center;flex-direction:column;gap:20px;transition:opacity .4s}
#loading-overlay.fade-out{opacity:0;pointer-events:none}
.spinner{width:44px;height:44px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-label{font-size:11px;color:var(--text-muted);letter-spacing:3px;text-transform:uppercase}

/* ‚îÄ‚îÄ CONNECTION STATUS BADGE ‚îÄ‚îÄ */
#conn-status{position:fixed;bottom:20px;left:20px;z-index:7000;font-size:10px;letter-spacing:2px;text-transform:uppercase;padding:6px 14px;border-radius:20px;border:1px solid;display:none;font-family:var(--font-m)}
#conn-status.ok{display:block;color:var(--success);border-color:rgba(0,230,118,.3);background:rgba(0,230,118,.08)}
#conn-status.fail{display:block;color:var(--danger);border-color:rgba(255,23,68,.3);background:rgba(255,23,68,.08)}
#conn-status.checking{display:block;color:var(--accent);border-color:rgba(0,229,255,.3);background:rgba(0,229,255,.08)}

/* ‚îÄ‚îÄ LOGIN SCREEN ‚îÄ‚îÄ */
#login-screen{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px;background:var(--bg);position:relative;overflow:hidden}
#login-screen::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse 60% 50% at 50% 50%,rgba(0,229,255,.04) 0%,transparent 70%);pointer-events:none}
.login-card{width:100%;max-width:420px;background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:48px 40px;box-shadow:var(--shadow),0 0 60px rgba(0,229,255,.05);position:relative;z-index:1;animation:slideUp .5s cubic-bezier(.4,0,.2,1)}
@keyframes slideUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
.login-logo{text-align:center;margin-bottom:36px}
.title-main{font-family:var(--font-d);font-size:32px;font-weight:800;letter-spacing:-1px;color:var(--text);line-height:1}
.title-sub{font-size:10px;letter-spacing:4px;color:var(--accent);text-transform:uppercase;margin-top:6px}
.brand-dot{display:inline-block;width:6px;height:6px;border-radius:50%;background:var(--accent);margin-right:3px;vertical-align:middle;animation:pulse 2s ease-in-out infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}

/* Connection test area in login */
.conn-test-area{margin-bottom:20px;padding:12px 16px;border-radius:var(--radius-sm);border:1px solid var(--border);background:var(--surface2);font-size:11px;color:var(--text-muted);display:flex;align-items:center;gap:10px}
.conn-test-msg{flex:1;line-height:1.5}
.conn-dot{width:8px;height:8px;border-radius:50%;background:var(--text-muted);flex-shrink:0;transition:background .3s}
.conn-dot.ok{background:var(--success);box-shadow:0 0 6px var(--success)}
.conn-dot.fail{background:var(--danger);box-shadow:0 0 6px var(--danger)}
.conn-dot.checking{background:var(--accent);animation:pulse .8s infinite}

/* ‚îÄ‚îÄ FORMS ‚îÄ‚îÄ */
.form-group{margin-bottom:20px}
.form-label{display:block;font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--text-muted);margin-bottom:8px}
.form-input{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-family:var(--font-m);font-size:14px;padding:12px 16px;outline:none;transition:border-color var(--tr),box-shadow var(--tr)}
.form-input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(0,229,255,.1)}
.form-input::placeholder{color:var(--text-muted)}
select.form-input{cursor:pointer}

.btn{font-family:var(--font-m);font-size:12px;letter-spacing:1px;font-weight:700;text-transform:uppercase;border:none;cursor:pointer;border-radius:var(--radius-sm);padding:12px 20px;transition:all var(--tr);display:inline-flex;align-items:center;gap:6px;justify-content:center}
.btn:disabled{opacity:.5;cursor:not-allowed}
.btn-primary{background:var(--accent);color:#000;width:100%}
.btn-primary:not(:disabled):hover{filter:brightness(1.15);box-shadow:var(--glow)}
.btn-secondary{background:var(--surface3);color:var(--text-dim);border:1px solid var(--border)}
.btn-secondary:hover{border-color:var(--accent);color:var(--accent)}
.btn-danger{background:rgba(255,23,68,.15);color:var(--danger);border:1px solid rgba(255,23,68,.3)}
.btn-danger:hover{background:var(--danger);color:#fff}
.btn-success{background:rgba(0,230,118,.12);color:var(--success);border:1px solid rgba(0,230,118,.3)}
.btn-success:hover{background:var(--success);color:#000}
.btn-sm{padding:6px 12px;font-size:10px}
.btn-icon{padding:8px;border-radius:var(--radius-sm);background:var(--surface3);border:1px solid var(--border);color:var(--text-dim);cursor:pointer;display:inline-flex;align-items:center;justify-content:center;transition:all var(--tr);font-size:14px;line-height:1}
.btn-icon:hover{border-color:var(--accent);color:var(--accent)}
.btn-icon.danger:hover{border-color:var(--danger);color:var(--danger)}

#login-error{color:var(--danger);font-size:11px;text-align:center;margin-top:12px;min-height:16px;line-height:1.6}
.retry-btn{background:none;border:none;color:var(--accent);cursor:pointer;font-family:var(--font-m);font-size:11px;text-decoration:underline;padding:0;margin-top:4px;display:inline}

/* ‚îÄ‚îÄ MAIN APP ‚îÄ‚îÄ */
#app-screen{display:none;min-height:100vh;flex-direction:column}
#app-screen.active{display:flex}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
.app-header{background:var(--surface);border-bottom:1px solid var(--border);padding:0 24px;height:64px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100}
.header-brand{display:flex;flex-direction:column}
.brand-name{font-family:var(--font-d);font-size:20px;font-weight:800;letter-spacing:-.5px;color:var(--text);line-height:1}
.brand-sub{font-size:9px;letter-spacing:3px;color:var(--accent);text-transform:uppercase}
.header-center{text-align:center;display:flex;flex-direction:column;align-items:center}
.header-time{font-size:15px;font-weight:700;color:var(--text);letter-spacing:1px;font-family:var(--font-m)}
.header-date{font-size:10px;color:var(--text-muted);letter-spacing:1px}
.header-actions{display:flex;align-items:center;gap:8px}

/* ‚îÄ‚îÄ BODY ‚îÄ‚îÄ */
.app-body{flex:1;padding:24px;max-width:1200px;width:100%;margin:0 auto}

/* ‚îÄ‚îÄ SEARCH ‚îÄ‚îÄ */
.search-wrapper{position:relative;margin-bottom:24px}
.search-icon{position:absolute;left:14px;top:50%;transform:translateY(-50%);color:var(--text-muted);pointer-events:none;font-size:14px}
#global-search{width:100%;padding:12px 16px 12px 42px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-family:var(--font-m);font-size:13px;outline:none;transition:border-color var(--tr),box-shadow var(--tr)}
#global-search:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(0,229,255,.08)}
#global-search::placeholder{color:var(--text-muted)}

/* ‚îÄ‚îÄ NEW ENTRY ‚îÄ‚îÄ */
.new-entry-bar{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
.section-label{font-size:10px;letter-spacing:3px;text-transform:uppercase;color:var(--text-muted)}
.form-dropdown{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;max-height:0;transition:max-height .45s cubic-bezier(.4,0,.2,1),opacity .3s;opacity:0;margin-bottom:16px}
.form-dropdown.open{max-height:2000px;opacity:1}
.form-dropdown-inner{padding:24px}
.form-grid{display:grid;grid-template-columns:1fr;gap:14px;margin-bottom:16px}
.form-footer{display:flex;gap:10px;justify-content:flex-end;padding-top:16px;border-top:1px solid var(--border)}

/* ‚îÄ‚îÄ ACCORDION TABS ‚îÄ‚îÄ */
.tab-section{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:12px;overflow:hidden;transition:border-color var(--tr)}
.tab-section.active{border-color:var(--border-bright)}
.tab-header{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;cursor:pointer;user-select:none;transition:background var(--tr)}
.tab-header:hover{background:var(--surface2)}
.tab-header-left{display:flex;align-items:center;gap:12px}
.tab-icon{width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px;background:var(--surface3);flex-shrink:0}
.tab-name{font-family:var(--font-d);font-size:15px;font-weight:700}
.tab-count{font-size:10px;letter-spacing:1px;color:var(--text-muted);background:var(--surface3);padding:2px 8px;border-radius:20px}
.tab-chevron{color:var(--text-muted);font-size:12px;transition:transform .3s;flex-shrink:0}
.tab-section.active .tab-chevron{transform:rotate(180deg)}
.tab-body{max-height:0;overflow:hidden;transition:max-height .45s cubic-bezier(.4,0,.2,1)}
.tab-section.active .tab-body{max-height:4000px}
.tab-body-inner{padding:0 20px 20px}

/* ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ */
.data-table-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch}
.data-table{width:100%;border-collapse:collapse;font-size:12px}
.data-table th{text-align:left;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--text-muted);padding:10px 12px;border-bottom:1px solid var(--border);white-space:nowrap}
.data-table td{padding:10px 12px;border-bottom:1px solid var(--border);color:var(--text-dim);vertical-align:middle;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.data-table tr:last-child td{border-bottom:none}
.data-table tbody tr:hover td{background:var(--surface2);color:var(--text)}
.pw-cell{position:relative}
.pw-mask{filter:blur(5px);cursor:pointer;user-select:none;transition:filter .2s;font-family:var(--font-m);letter-spacing:2px;display:inline-block}
.pw-mask:hover,.pw-mask.revealed{filter:none}
.td-actions{display:flex;gap:6px;align-items:center;white-space:nowrap}
.no-data{text-align:center;padding:40px 20px;color:var(--text-muted);font-size:11px;letter-spacing:2px;text-transform:uppercase}
.error-data{text-align:center;padding:20px;color:var(--danger);font-size:12px;line-height:1.8}

/* ‚îÄ‚îÄ SKELETON LOADER ‚îÄ‚îÄ */
.skel-wrap{padding:8px 0}
.skel-row{display:flex;gap:12px;padding:10px 12px}
.skel-cell{height:12px;border-radius:4px;background:linear-gradient(90deg,var(--surface2) 25%,var(--surface3) 50%,var(--surface2) 75%);background-size:200% 100%;animation:shimmer 1.5s infinite;flex-shrink:0}
@keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}

/* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
.modal-overlay{position:fixed;inset:0;z-index:7777;background:rgba(0,0,0,.75);display:none;align-items:center;justify-content:center;padding:24px;backdrop-filter:blur(4px)}
.modal-overlay.open{display:flex}
.modal{background:var(--surface);border:1px solid var(--border-bright);border-radius:14px;width:100%;max-width:560px;box-shadow:var(--shadow);animation:modalIn .3s cubic-bezier(.4,0,.2,1);max-height:90vh;overflow-y:auto}
@keyframes modalIn{from{opacity:0;transform:scale(.95) translateY(-10px)}to{opacity:1;transform:none}}
.modal-header{display:flex;align-items:center;justify-content:space-between;padding:20px 24px 0}
.modal-title{font-family:var(--font-d);font-size:16px;font-weight:700}
.modal-close{background:none;border:none;color:var(--text-muted);font-size:22px;cursor:pointer;padding:4px 6px;transition:color var(--tr);line-height:1}
.modal-close:hover{color:var(--danger)}
.modal-body{padding:20px 24px}
.modal-footer{display:flex;gap:10px;justify-content:flex-end;padding:0 24px 24px}

/* ‚îÄ‚îÄ SETTINGS PANEL ‚îÄ‚îÄ */
.settings-panel{position:fixed;top:0;right:0;bottom:0;width:320px;z-index:6666;background:var(--surface);border-left:1px solid var(--border);box-shadow:-8px 0 32px rgba(0,0,0,.4);transform:translateX(100%);transition:transform .35s cubic-bezier(.4,0,.2,1);display:flex;flex-direction:column}
.settings-panel.open{transform:translateX(0)}
.settings-header{display:flex;align-items:center;justify-content:space-between;padding:20px 24px;border-bottom:1px solid var(--border)}
.settings-title{font-family:var(--font-d);font-size:16px;font-weight:700}
.settings-body{flex:1;overflow-y:auto;padding:24px}
.settings-section{margin-bottom:32px}
.settings-section-label{font-size:9px;letter-spacing:3px;text-transform:uppercase;color:var(--accent);margin-bottom:16px}
.settings-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.settings-label{font-size:12px;color:var(--text-dim)}

/* ‚îÄ‚îÄ TOGGLE SWITCH ‚îÄ‚îÄ */
.toggle{width:44px;height:24px;position:relative;display:inline-block;flex-shrink:0}
.toggle input{opacity:0;width:0;height:0;position:absolute}
.toggle-slider{position:absolute;inset:0;background:var(--surface3);border:1px solid var(--border);border-radius:12px;cursor:pointer;transition:background var(--tr)}
.toggle-slider::before{content:'';position:absolute;width:18px;height:18px;left:2px;top:2px;background:var(--text-muted);border-radius:50%;transition:transform var(--tr),background var(--tr)}
.toggle input:checked+.toggle-slider{background:rgba(0,229,255,.2);border-color:var(--accent)}
.toggle input:checked+.toggle-slider::before{transform:translateX(20px);background:var(--accent)}

/* ‚îÄ‚îÄ CONFIRM DIALOG ‚îÄ‚îÄ */
.confirm-message{color:var(--text-dim);font-size:13px;line-height:1.7}

/* ‚îÄ‚îÄ INFO POPUP ‚îÄ‚îÄ */
.info-modal{max-width:600px}
.info-modal .modal-header{border-bottom:1px solid var(--border);padding-bottom:16px;margin-bottom:0}
.info-modal-badge{display:inline-flex;align-items:center;gap:8px;font-size:11px;letter-spacing:2px;text-transform:uppercase;color:var(--accent);background:rgba(0,229,255,.08);border:1px solid rgba(0,229,255,.2);padding:4px 12px;border-radius:20px}
.info-fields{display:flex;flex-direction:column;gap:0}
.info-field{display:flex;flex-direction:column;gap:4px;padding:12px 0;border-bottom:1px solid var(--border)}
.info-field:last-child{border-bottom:none}
.info-field-label{font-size:9px;letter-spacing:2.5px;text-transform:uppercase;color:var(--text-muted)}
.info-field-value{font-size:13px;color:var(--text);line-height:1.65;word-break:break-word;white-space:pre-wrap}
.info-field-value.pw-val{font-family:var(--font-m);letter-spacing:2px;filter:blur(5px);cursor:pointer;transition:filter .2s;user-select:none}
.info-field-value.pw-val:hover,.info-field-value.pw-val.revealed{filter:none}
.info-field-value.long-val{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:10px 14px;font-size:13px;max-height:200px;overflow-y:auto}
.info-field-value.empty-val{color:var(--text-muted);font-style:italic;font-size:12px}
/* Row is clickable */
.data-table tbody tr{cursor:pointer}
.data-table tbody tr td.td-act-cell{cursor:default}

/* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
@media(max-width:600px){
  .app-header{padding:0 16px;height:56px}
  .header-center{display:none}
  .app-body{padding:16px}
  .form-grid{grid-template-columns:1fr}
  .login-card{padding:36px 24px}
  .settings-panel{width:100%}
  .data-table th,.data-table td{padding:8px 6px;font-size:11px}
  .new-entry-bar{flex-direction:column;align-items:flex-start;gap:10px}
  .modal{max-height:95vh}
}
</style>
</head>
<body>

<!-- LOADING OVERLAY -->
<div id="loading-overlay">
  <div class="spinner"></div>
  <div class="loading-label">Connecting...</div>
</div>

<!-- TOAST CONTAINER -->
<div id="toast-container"></div>

<!-- CONNECTION STATUS BADGE -->
<div id="conn-status"></div>

<!-- ‚îÄ‚îÄ CONFIRM DELETE DIALOG ‚îÄ‚îÄ -->
<div class="modal-overlay" id="confirm-dialog">
  <div class="modal" style="max-width:380px">
    <div class="modal-header">
      <span class="modal-title">‚ö† Confirm Delete</span>
      <button class="modal-close" onclick="closeConfirm()">&times;</button>
    </div>
    <div class="modal-body">
      <p class="confirm-message" id="confirm-message"></p>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeConfirm()">Cancel</button>
      <button class="btn btn-danger" id="confirm-ok-btn">üóë Delete</button>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ EDIT MODAL ‚îÄ‚îÄ -->
<div class="modal-overlay" id="edit-modal">
  <div class="modal">
    <div class="modal-header">
      <span class="modal-title" id="edit-modal-title">Edit Entry</span>
      <button class="modal-close" onclick="closeEditModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-grid" id="edit-form-grid"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
      <button class="btn btn-success" id="save-edit-btn" onclick="submitEdit()">‚úì Save Changes</button>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ INFO POPUP MODAL ‚îÄ‚îÄ -->
<div class="modal-overlay" id="info-modal">
  <div class="modal info-modal">
    <div class="modal-header">
      <div style="display:flex;flex-direction:column;gap:6px">
        <span class="modal-title" id="info-modal-title">Entry Details</span>
        <span class="info-modal-badge" id="info-modal-badge"></span>
      </div>
      <button class="modal-close" onclick="closeInfoModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="info-fields" id="info-fields"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeInfoModal()">Close</button>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ LOGIN SCREEN ‚îÄ‚îÄ -->
<div id="login-screen">
  <div class="login-card">
    <div class="login-logo">
      <div class="title-main"><span class="brand-dot"></span>Master File</div>
      <div class="title-sub">by RekzBanz</div>
    </div>

    <div class="conn-test-area" id="login-conn-area">
      <span class="conn-dot checking" id="login-conn-dot"></span>
      <span class="conn-test-msg" id="login-conn-msg">Checking connection to Google Sheets...</span>
    </div>

    <div class="form-group">
      <label class="form-label">Admin Password</label>
      <input type="password" id="login-pw-input" class="form-input" placeholder="Enter password..." autocomplete="current-password"/>
    </div>
    <button class="btn btn-primary" id="login-btn" onclick="attemptLogin()" disabled>‚ñ∂ Sign In</button>
    <div id="login-error"></div>
  </div>
</div>

<!-- ‚îÄ‚îÄ MAIN APP SCREEN ‚îÄ‚îÄ -->
<div id="app-screen">
  <header class="app-header">
    <div class="header-brand">
      <span class="brand-name">Master File</span>
      <span class="brand-sub">by RekzBanz</span>
    </div>
    <div class="header-center">
      <div class="header-time" id="live-time">--:--:--</div>
      <div class="header-date" id="live-date">---</div>
    </div>
    <div class="header-actions">
      <button class="btn-icon" title="Refresh All Data" onclick="refreshAll()">‚ü≥</button>
      <button class="btn-icon" title="Settings" onclick="openSettings()">‚öô</button>
      <button class="btn btn-secondary btn-sm" onclick="logout()">Logout</button>
    </div>
  </header>

  <main class="app-body">
    <div class="search-wrapper">
      <span class="search-icon">üîç</span>
      <input type="text" id="global-search" placeholder="Search across all visible data..." oninput="filterAll(this.value)"/>
    </div>

    <div class="new-entry-bar">
      <span class="section-label">Data Management</span>
      <button class="btn btn-primary btn-sm" onclick="toggleNewEntry()">+ New Entry</button>
    </div>

    <!-- NEW ENTRY ANIMATED DROPDOWN -->
    <div class="form-dropdown" id="new-entry-form">
      <div class="form-dropdown-inner">
        <div class="form-group" style="margin-bottom:14px">
          <label class="form-label">Target Sheet Tab</label>
          <select class="form-input" id="new-entry-sheet" onchange="buildNewEntryFields()">
            <option value="MyPWs">MyPWs</option>
            <option value="PNPpw">PNPpw</option>
            <option value="UrPWs">UrPWs</option>
            <option value="PersonalEvts">PersonalEvts</option>
            <option value="StnEvnts">StnEvnts</option>
            <option value="ClientInfo">ClientInfo</option>
          </select>
        </div>
        <div class="form-grid" id="new-entry-fields"></div>
        <div class="form-footer">
          <button class="btn btn-secondary" onclick="toggleNewEntry()">Cancel</button>
          <button class="btn btn-success" id="add-entry-btn" onclick="submitNewEntry()">‚úì Add Entry</button>
        </div>
      </div>
    </div>

    <!-- TAB ACCORDION CONTAINER -->
    <div id="tabs-container"></div>
  </main>
</div>

<!-- ‚îÄ‚îÄ SETTINGS SIDE PANEL ‚îÄ‚îÄ -->
<div class="settings-panel" id="settings-panel">
  <div class="settings-header">
    <span class="settings-title">‚öô Settings</span>
    <button class="modal-close" onclick="closeSettings()">&times;</button>
  </div>
  <div class="settings-body">

    <div class="settings-section">
      <div class="settings-section-label">Connection</div>
      <div style="font-size:11px;color:var(--text-muted);margin-bottom:10px;line-height:1.5" id="settings-conn-info">‚Äî</div>
      <button class="btn btn-secondary w-full" onclick="testConnectionVerbose()">‚ñ∂ Test Connection</button>
    </div>

    <div class="settings-section">
      <div class="settings-section-label">Appearance</div>
      <div class="settings-row">
        <span class="settings-label">Light Mode</span>
        <label class="toggle">
          <input type="checkbox" id="theme-toggle" onchange="toggleTheme(this.checked)"/>
          <span class="toggle-slider"></span>
        </label>
      </div>
    </div>

    <div class="settings-section">
      <div class="settings-section-label">Change Password</div>
      <div class="form-group">
        <label class="form-label">New Password</label>
        <input type="password" id="new-password-input" class="form-input" placeholder="Enter new password..."/>
      </div>
      <div class="form-group">
        <label class="form-label">Confirm New Password</label>
        <input type="password" id="confirm-password-input" class="form-input" placeholder="Confirm password..."/>
      </div>
      <button class="btn btn-primary w-full" onclick="changePassword()">Save Password</button>
    </div>

    <div class="settings-section">
      <div class="settings-section-label">Data</div>
      <button class="btn btn-secondary w-full" onclick="refreshAll(); closeSettings()">‚ü≥ Refresh All Data</button>
    </div>

    <div class="settings-section">
      <div class="settings-section-label">Session</div>
      <button class="btn btn-danger w-full" onclick="logout()">Logout</button>
    </div>
  </div>
</div>

<script>
'use strict';

// ============================================================
//  CONFIG ‚Äî Update this URL if you redeploy the Apps Script
// ============================================================
const API_URL = 'https://script.google.com/macros/s/AKfycbzi8xpjG_vglxM4_xq44hFpZj_TgybfUUaUTaSc3OiyZDR_L3wUnq0mT9f8DzhDV5_o/exec';

// ============================================================
//  SHEET DEFINITIONS
//  headers: exact column order matching your Google Sheet rows
// ============================================================
const SHEET_CONFIG = {
  MyPWs:        { icon:'üîê', type:'password', headers:['Nr','Types','Sites','Owners','Users','pw','Remarks'] },
  PNPpw:        { icon:'üõ°Ô∏è', type:'password', headers:['Nr','Types','Sites','Owners','Users','pw','Remarks'] },
  UrPWs:        { icon:'üîë', type:'password', headers:['Nr','Types','Sites','Owners','Users','pw','Remarks'] },
  PersonalEvts: { icon:'üìÖ', type:'event',    headers:['No.','Date','Time','Subject/details','Remarks'] },
  StnEvnts:     { icon:'üìå', type:'event',    headers:['No.','Date','Time','Subject/details','Remarks'] },
  ClientInfo:   { icon:'üë§', type:'event',    headers:['No.','Date','Time','Name','Birthdate','Gender','Civil Status','Address','Contact Nr','Remarks'] }
};
const TABS_ORDER = ['MyPWs','PNPpw','UrPWs','PersonalEvts','StnEvnts','ClientInfo'];

// ============================================================
//  APPLICATION STATE
// ============================================================
const appState = {
  adminPassword: '',
  sheetData: {},    // { [sheetName]: [[row], [row], ...] }  (index 0 = headers)
  editTarget: null, // { name, rowIdx }
  searchQuery: ''
};

// ============================================================
//  UTILITY: Safe CSS/element ID from header string
//  Headers like "Subject/details" and "No." contain chars that
//  break getElementById and querySelector ‚Äî strip them.
// ============================================================
function safeId(header) {
  return header.replace(/[^a-zA-Z0-9]/g, '_');
}
// ============================================================
//  DATE FORMATTER ‚Äî converts any stored date to "2026 Feb 21"
// ============================================================
function formatDate(val) {
  if (!val || !String(val).trim()) return val;
  var s = String(val).trim();
  const MONTHS = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

  // yyyy-MM-dd from <input type="date"> or Google Sheets e.g. "2026-02-21"
  var match = s.match(/^(\d{4})-(\d{2})-(\d{2})/);
  if (match) {
    var yr  = match[1];
    var mon = MONTHS[parseInt(match[2], 10) - 1];
    var day = parseInt(match[3], 10);
    return yr + ' ' + mon + ' ' + day;
  }

  // Already formatted or unrecognized ‚Äî return as-is
  return s;
}

// ============================================================
//  TIME FORMATTER ‚Äî converts "13:00" ‚Üí "1:00 PM"
// ============================================================
function formatTime(val) {
  if (!val || !String(val).trim()) return val;

  const s = String(val).trim();

  // ‚ùó CASE 1: Google Sheets time stored as date (e.g. 1899-12-30T13:00:00)
  const d = new Date(s);
  if (!isNaN(d.getTime())) {
    let hours = d.getHours();
    let minutes = String(d.getMinutes()).padStart(2, '0');

    const ampm = hours >= 12 ? 'PM' : 'AM';
    hours = hours % 12;
    if (hours === 0) hours = 12;

    return `${hours}:${minutes} ${ampm}`;
  }

  // ‚ùó CASE 2: Normal "HH:mm"
  const match = s.match(/^(\d{2}):(\d{2})/);
  if (match) {
    let hours = parseInt(match[1], 10);
    const minutes = match[2];

    const ampm = hours >= 12 ? 'PM' : 'AM';
    hours = hours % 12;
    if (hours === 0) hours = 12;

    return `${hours}:${minutes} ${ampm}`;
  }

  return s;
}
  
// ============================================================
//  HTML ESCAPE HELPERS
// ============================================================
function escHtml(s) {
  return String(s)
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;')
    .replace(/'/g,'&#39;');
}
function escAttr(s) {
  return String(s)
    .replace(/&/g,'&amp;')
    .replace(/"/g,'&quot;')
    .replace(/'/g,'&#39;');
}

// ============================================================
//  API LAYER
//  ALL requests go via GET to avoid CORS preflight.
//  Google Apps Script cannot respond to OPTIONS requests,
//  so POST from a browser always fails with CORS error.
//  Solution: encode everything in GET URL parameters.
// ============================================================
async function apiGet(params) {
  const qs = new URLSearchParams(params).toString();
  const url = `${API_URL}?${qs}`;
  const res = await fetch(url, {
    method: 'GET',
    redirect: 'follow'   // GAS redirects to the actual script URL ‚Äî follow it
  });
  if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
  const text = await res.text();
  let json;
  try {
    json = JSON.parse(text);
  } catch(e) {
    throw new Error('Invalid JSON from server. Verify your Apps Script is deployed correctly (Execute as: Me, Access: Anyone).');
  }
  if (!json.success) throw new Error(json.error || 'API returned failure without a message.');
  return json;
}

// Write operations also go through GET (same function, just aliased for clarity)
async function apiWrite(params) {
  return apiGet(params);
}

// ============================================================
//  TOAST NOTIFICATIONS
// ============================================================
function toast(msg, type = 'info', duration = 3000) {
  const container = document.getElementById('toast-container');
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  el.textContent = msg;
  const showMs = 300;
  const hideMs = duration - 300;
  el.style.animation = `toastIn ${showMs}ms forwards, toastOut 300ms ${hideMs}ms forwards`;
  container.appendChild(el);
  setTimeout(() => { if (el.parentNode) el.parentNode.removeChild(el); }, duration + 50);
}

// ============================================================
//  LOADING OVERLAY
// ============================================================
const loadingOverlay = document.getElementById('loading-overlay');
function showLoading(label = 'Loading...') {
  loadingOverlay.querySelector('.loading-label').textContent = label;
  loadingOverlay.classList.remove('fade-out');
  loadingOverlay.style.display = 'flex';
}
function hideLoading() {
  loadingOverlay.classList.add('fade-out');
  setTimeout(() => { loadingOverlay.style.display = 'none'; }, 450);
}

// ============================================================
//  CONNECTION STATUS BADGE (bottom-left)
// ============================================================
function setConnBadge(status) {
  // status: 'ok' | 'fail' | 'checking'
  const el = document.getElementById('conn-status');
  el.className = status;
  el.textContent = status === 'ok' ? '‚óè Connected'
                 : status === 'fail' ? '‚óè Disconnected'
                 : '‚óè Connecting...';
}

// ============================================================
//  TEST CONNECTION
// ============================================================
async function testConnection() {
  const dot = document.getElementById('login-conn-dot');
  const msg = document.getElementById('login-conn-msg');
  const info = document.getElementById('settings-conn-info');
  const loginBtn = document.getElementById('login-btn');

  if (dot) { dot.className = 'conn-dot checking'; }
  if (msg) msg.textContent = 'Connecting to Google Sheets...';
  if (info) info.textContent = 'Testing...';
  setConnBadge('checking');

  try {
    const res = await apiGet({ action: 'ping' });
    if (dot) dot.className = 'conn-dot ok';
    if (msg) msg.textContent = 'Connected ‚úì  ' + (res.message || '');
    if (info) info.textContent = `Connected ¬∑ ${new Date().toLocaleTimeString()}`;
    if (loginBtn) loginBtn.disabled = false;
    setConnBadge('ok');
    return true;
  } catch(e) {
    if (dot) dot.className = 'conn-dot fail';
    if (msg) {
      msg.innerHTML = `Connection failed: ${escHtml(e.message)}<br>
        <button class="retry-btn" onclick="initApp()">‚Üª Retry</button>`;
    }
    if (info) info.textContent = `Failed: ${e.message}`;
    if (loginBtn) loginBtn.disabled = false; // still allow manual attempt
    setConnBadge('fail');
    return false;
  }
}

async function testConnectionVerbose() {
  const ok = await testConnection();
  if (ok) toast('Connection successful!', 'success');
  else toast('Connection failed. Check Apps Script deployment.', 'error', 5000);
}

// ============================================================
//  LIVE CLOCK
// ============================================================
function updateClock() {
  const now = new Date();
  const DAYS   = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
  const MONTHS = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const hh = String(now.getHours()).padStart(2,'0');
  const mm = String(now.getMinutes()).padStart(2,'0');
  const ss = String(now.getSeconds()).padStart(2,'0');
  const tEl = document.getElementById('live-time');
  const dEl = document.getElementById('live-date');
  if (tEl) tEl.textContent = `${hh}:${mm}:${ss}`;
  if (dEl) dEl.textContent = `${DAYS[now.getDay()]} ¬∑ ${MONTHS[now.getMonth()]} ${now.getDate()}, ${now.getFullYear()}`;
}
setInterval(updateClock, 1000);
updateClock();

// ============================================================
//  THEME ‚Äî restore on page load before anything renders
// ============================================================
(function applyTheme() {
  const saved = localStorage.getItem('mf_theme');
  if (saved === 'light') {
    document.documentElement.setAttribute('data-theme', 'light');
    // Toggle will be checked once DOM is ready (see initApp)
  }
})();

function toggleTheme(isLight) {
  document.documentElement.setAttribute('data-theme', isLight ? 'light' : 'dark');
  localStorage.setItem('mf_theme', isLight ? 'light' : 'dark');
}

// ============================================================
//  APP INIT (runs on DOMContentLoaded)
// ============================================================
async function initApp() {
  showLoading('Connecting to Google Sheets...');

  // Sync theme toggle state
  const savedTheme = localStorage.getItem('mf_theme');
  const themeToggle = document.getElementById('theme-toggle');
  if (themeToggle) themeToggle.checked = (savedTheme === 'light');

  try {
    // Fetch password ‚Äî also serves as a connection test
    const res = await apiGet({ action: 'getPassword' });
    appState.adminPassword = String(res.password);

    const dot = document.getElementById('login-conn-dot');
    const msg = document.getElementById('login-conn-msg');
    if (dot) dot.className = 'conn-dot ok';
    if (msg) msg.textContent = 'Connected to Google Sheets ‚úì';
    document.getElementById('login-btn').disabled = false;
    setConnBadge('ok');

    // Auto-login if session is still valid
    if (localStorage.getItem('mf_session') === 'authenticated') {
      enterApp();
    }
  } catch(e) {
    const dot = document.getElementById('login-conn-dot');
    const msg = document.getElementById('login-conn-msg');
    if (dot) dot.className = 'conn-dot fail';
    if (msg) {
      msg.innerHTML = `Connection failed: ${escHtml(e.message)}<br>
        <button class="retry-btn" onclick="initApp()">‚Üª Retry</button>`;
    }
    document.getElementById('login-btn').disabled = false;
    setConnBadge('fail');
    document.getElementById('login-error').innerHTML =
      `‚ö† Cannot reach Google Sheets.<br>
       Ensure your Apps Script is deployed as a Web App with<br>
       <strong>Execute as: Me</strong> and <strong>Access: Anyone</strong>.`;
  }

  hideLoading();
}

// ============================================================
//  ENTER MAIN APP
// ============================================================
function enterApp() {
  document.getElementById('login-screen').style.display = 'none';
  const appScreen = document.getElementById('app-screen');
  appScreen.classList.add('active');
  buildTabs();
  buildNewEntryFields();
  loadAllData();
}

// ============================================================
//  LOGIN
// ============================================================
async function attemptLogin() {
  const input = document.getElementById('login-pw-input').value;
  const errEl = document.getElementById('login-error');
  errEl.textContent = '';

  if (!input) { errEl.textContent = 'Please enter a password.'; return; }

  // If password was not fetched yet (connection failed), try again
  if (!appState.adminPassword) {
    errEl.textContent = 'Fetching password...';
    try {
      const res = await apiGet({ action: 'getPassword' });
      appState.adminPassword = String(res.password);
      errEl.textContent = '';
    } catch(e) {
      errEl.textContent = 'Cannot connect to server. Check your internet and retry.';
      return;
    }
  }

  if (input === appState.adminPassword) {
    localStorage.setItem('mf_session', 'authenticated');
    enterApp();
  } else {
    errEl.textContent = '‚úï Incorrect password. Please try again.';
    document.getElementById('login-pw-input').value = '';
    document.getElementById('login-pw-input').focus();
  }
}

document.getElementById('login-pw-input').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') attemptLogin();
});

// ============================================================
//  LOGOUT
// ============================================================
function logout() {
  localStorage.removeItem('mf_session');
  appState.sheetData = {};
  appState.adminPassword = '';
  appState.editTarget = null;
  appState.searchQuery = '';

  closeSettings();
  document.getElementById('login-screen').style.display = 'flex';
  document.getElementById('app-screen').classList.remove('active');
  document.getElementById('login-pw-input').value = '';
  document.getElementById('login-error').textContent = '';
  document.getElementById('global-search').value = '';

  toast('Logged out.', 'info');
  // Re-init to refresh the password from the sheet
  setTimeout(initApp, 200);
}

// ============================================================
//  SETTINGS PANEL
// ============================================================
function openSettings() { document.getElementById('settings-panel').classList.add('open'); }
function closeSettings() { document.getElementById('settings-panel').classList.remove('open'); }

async function changePassword() {
  const np = document.getElementById('new-password-input').value.trim();
  const cp = document.getElementById('confirm-password-input').value.trim();
  if (!np) { toast('Enter a new password.', 'error'); return; }
  if (np.length < 4) { toast('Password must be at least 4 characters.', 'error'); return; }
  if (np !== cp) { toast('Passwords do not match.', 'error'); return; }

  try {
    await apiWrite({ action: 'updatePassword', password: np });
    appState.adminPassword = np;
    document.getElementById('new-password-input').value = '';
    document.getElementById('confirm-password-input').value = '';
    toast('Password updated successfully!', 'success');
  } catch(e) {
    toast('Error updating password: ' + e.message, 'error', 5000);
  }
}

// ============================================================
//  BUILD ACCORDION TABS
// ============================================================
function buildTabs() {
  const container = document.getElementById('tabs-container');
  container.innerHTML = '';
  TABS_ORDER.forEach(function(name) {
    const cfg = SHEET_CONFIG[name];
    const section = document.createElement('div');
    section.className = 'tab-section';
    section.id = `tab-${name}`;
    section.innerHTML = `
      <div class="tab-header" onclick="toggleTab('${name}')">
        <div class="tab-header-left">
          <div class="tab-icon">${cfg.icon}</div>
          <span class="tab-name">${escHtml(name)}</span>
          <span class="tab-count" id="count-${name}">‚Ä¶</span>
        </div>
        <span class="tab-chevron">‚ñæ</span>
      </div>
      <div class="tab-body">
        <div class="tab-body-inner">
          <div id="table-${name}">${skeletonLoader(cfg.headers.length + 1)}</div>
        </div>
      </div>`;
    container.appendChild(section);
  });
}

function skeletonLoader(cols) {
  const widths = [40,80,120,100,90,70,110,60,95];
  let html = '<div class="skel-wrap">';
  for (let r = 0; r < 4; r++) {
    html += '<div class="skel-row">';
    for (let c = 0; c < cols; c++) {
      html += `<div class="skel-cell" style="width:${widths[c % widths.length]}px"></div>`;
    }
    html += '</div>';
  }
  return html + '</div>';
}

function toggleTab(name) {
  document.getElementById(`tab-${name}`).classList.toggle('active');
}

// ============================================================
//  LOAD DATA
// ============================================================
async function loadAllData() {
  await Promise.all(TABS_ORDER.map(function(s) { return loadSheetData(s); }));
}

async function loadSheetData(name) {
  try {
    const res = await apiGet({ action: 'getData', sheet: name });
    // res.data is an array of arrays: [headerRow, dataRow1, dataRow2, ...]
    appState.sheetData[name] = res.data || [];
    renderTable(name, appState.searchQuery);
  } catch(e) {
    const tableEl = document.getElementById(`table-${name}`);
    if (tableEl) {
      tableEl.innerHTML = `<div class="error-data">
        ‚ö† Failed to load "${escHtml(name)}": ${escHtml(e.message)}<br>
        <button class="retry-btn" style="margin-top:8px" onclick="loadSheetData('${name}')">‚Üª Retry</button>
      </div>`;
    }
    const countEl = document.getElementById(`count-${name}`);
    if (countEl) countEl.textContent = 'Error';
  }
}

// ============================================================
//  RENDER TABLE
//  rawData[0]         = header row (used for config only)
//  rawData[1..n]      = actual data rows
//  Sheet row index    = array index + 1  (1-based)
//  So rawData[1] corresponds to sheet row 2 (rowIndex=2)
// ============================================================
function renderTable(name, filter) {
  const cfg = SHEET_CONFIG[name];
  const rawData = appState.sheetData[name] || [];

  // Slice off the header row; data rows start at index 1
  // Attach original index BEFORE filtering so rowIdx always points to the real sheet row
  let allRows = rawData.length > 1 ? rawData.slice(1).map(function(row, i) {
    return { row: row, origIdx: i };
  }) : [];

  // ‚îÄ‚îÄ SORT by Date column (newest ‚Üí oldest) if this sheet has one ‚îÄ‚îÄ
  var dateColIdx = cfg.headers.indexOf('Date');
  if (dateColIdx !== -1) {
    allRows.sort(function(a, b) {
      var rawA = a.row[dateColIdx] ? String(a.row[dateColIdx]).trim() : '';
      var rawB = b.row[dateColIdx] ? String(b.row[dateColIdx]).trim() : '';
      var da = rawA ? new Date(rawA) : new Date(0);
      var db = rawB ? new Date(rawB) : new Date(0);
      // Invalid dates fall to the bottom
      if (isNaN(da.getTime())) da = new Date(0);
      if (isNaN(db.getTime())) db = new Date(0);
      return db - da; // descending: newest first
    });
  }

  // Apply search filter (filter on row content, but keep origIdx intact)
  if (filter && filter.trim()) {
    const q = filter.trim().toLowerCase();
    allRows = allRows.filter(function(item) {
      return item.row.some(function(cell) { return String(cell).toLowerCase().includes(q); });
    });
  }

  const dataRows = allRows; // each item: { row, origIdx }

  const countEl = document.getElementById(`count-${name}`);
  if (countEl) countEl.textContent = `${dataRows.length} entr${dataRows.length === 1 ? 'y' : 'ies'}`;

  const container = document.getElementById(`table-${name}`);
  if (!container) return;

  if (dataRows.length === 0) {
    container.innerHTML = `<div class="no-data">${filter ? 'üîç No matching entries' : '+ No data yet ‚Äî add your first entry!'}</div>`;
    return;
  }

  const hs = cfg.headers;
  let html = `<div class="data-table-wrap"><table class="data-table"><thead><tr>
    ${hs.map(function(h) { return `<th>${escHtml(h)}</th>`; }).join('')}
    <th>Actions</th>
  </tr></thead><tbody>`;

  dataRows.forEach(function(item) {
    const row = item.row;
    // origIdx is 0-based index in rawData.slice(1), so sheet row = origIdx + 2
    const rowIdx = item.origIdx + 2;

    html += `<tr onclick="openInfoPopup('${name}',${rowIdx})">`;
    hs.forEach(function(h, ci) {
      const raw  = (row[ci] !== undefined && row[ci] !== null) ? row[ci] : '';
      const cell = escHtml(String(raw));
      if (h === 'pw') {
        html += `<td class="pw-cell"><span class="pw-mask" onclick="this.classList.toggle('revealed')" title="Click to reveal">${cell || '‚Äî'}</span></td>`;
      } else if (h === 'Date' || h === 'Birthdate') {
        var dateFmt = escHtml(formatDate(String(raw)));
        html += `<td title="${dateFmt}">${dateFmt || '‚Äî'}</td>`;
      } else if (h === 'Time') {
  var timeFmt = escHtml(formatTime(String(raw)));
  html += `<td title="${timeFmt}">${timeFmt || '‚Äî'}</td>`;
} else {
  html += `<td title="${cell}">${cell || '‚Äî'}</td>`;
}
    });
    html += `<td class="td-act-cell" onclick="event.stopPropagation()"><div class="td-actions">
      <button class="btn-icon" title="Edit entry" onclick="openEdit('${name}',${rowIdx})">‚úé</button>
      <button class="btn-icon danger" title="Delete entry" onclick="confirmDelete('${name}',${rowIdx})">üóë</button>
    </div></td></tr>`;
  });

  html += `</tbody></table></div>`;
  container.innerHTML = html;
}

// ============================================================
//  GLOBAL SEARCH
// ============================================================
function filterAll(query) {
  appState.searchQuery = query;
  TABS_ORDER.forEach(function(s) { renderTable(s, query); });
}

// ============================================================
//  NEW ENTRY FORM (animated dropdown)
// ============================================================
let newEntryOpen = false;

function toggleNewEntry() {
  newEntryOpen = !newEntryOpen;
  document.getElementById('new-entry-form').classList.toggle('open', newEntryOpen);
  if (newEntryOpen) buildNewEntryFields();
}

async function buildNewEntryFields() {
  const name = document.getElementById('new-entry-sheet').value;
  const cfg = SHEET_CONFIG[name];
  const container = document.getElementById('new-entry-fields');
  container.innerHTML = cfg.headers.map(function(h) {
    return makeFieldHTML(`nf_${safeId(h)}`, h);
  }).join('');

  // ‚îÄ‚îÄ AUTO-FILL entry number ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // If data for this sheet isn't loaded yet, fetch it first
  if (!appState.sheetData[name] || appState.sheetData[name].length === 0) {
    await loadSheetData(name);
  }

  const rawData = appState.sheetData[name] || [];
  // rawData[0] = header row, so data rows = rawData.length - 1
  const nextNum = rawData.length > 1 ? rawData.length : 1;

  const numField = document.getElementById('nf_Nr') || document.getElementById('nf_No_');
  if (numField) {
    numField.value = nextNum;
    numField.readOnly = true;
    numField.style.opacity = '0.5';
    numField.style.cursor  = 'not-allowed';
  }
}

function makeFieldHTML(id, header) {
  const isWide = (header === 'Remarks' || header === 'Subject/details');
  const spanStyle = '';
  let inputHtml;
  if (header === 'pw') {
    inputHtml = `<input type="password" id="${id}" class="form-input" placeholder="Password..."/>`;
  } else if (header === 'Date') {
    inputHtml = `<input type="date" id="${id}" class="form-input"/>`;
  } else if (header === 'Time') {
    inputHtml = `<input type="time" id="${id}" class="form-input"/>`;
    } else if (header === 'Birthdate') {
    inputHtml = `<input type="Date" id="${id}" class="form-input"/>`;
   } else if (header === 'Civil Status') {
    inputHtml = `
        <select id="${id}" class="form-input">
            <option value=""></option>
            <option value="Single">Single</option>
            <option value="Married">Married</option>
            <option value="Separated">Separated</option>
            <option value="Widow/er">Widow/er</option>
        </select>`;
   } else if (header === 'Gender') {
    inputHtml = `
        <select id="${id}" class="form-input">
            <option value=""></option>
            <option value="Male">Male</option>
            <option value="Female">Female</option>
            <option value="Gay">Gay</option>
            <option value="Lesbian">Lesbian</option>
            <option value="Bisexual">Bisexual</option>
        </select>`;
  } else {
    inputHtml = `<input type="text" id="${id}" class="form-input" placeholder="${escAttr(header)}..."/>`;
  }
  return `<div class="form-group"${spanStyle}><label class="form-label">${escHtml(header)}</label>${inputHtml}</div>`;
}

async function submitNewEntry() {
  const name = document.getElementById('new-entry-sheet').value;
  const cfg  = SHEET_CONFIG[name];
  const btn  = document.getElementById('add-entry-btn');

  const row = cfg.headers.map(function(h) {
    const el = document.getElementById(`nf_${safeId(h)}`);
    return el ? el.value.trim() : '';
  });

  if (row.every(function(v) { return !v; })) {
    toast('Please fill in at least one field.', 'error');
    return;
  }

  btn.disabled = true;
  btn.textContent = 'Adding...';

  try {
    // row is JSON-stringified and sent as a URL GET parameter
    await apiWrite({ action: 'addRow', sheet: name, row: JSON.stringify(row) });
    toast(`Entry added to ${name}!`, 'success');

    // Clear form fields
    cfg.headers.forEach(function(h) {
      const el = document.getElementById(`nf_${safeId(h)}`);
      if (el) el.value = '';
    });

    // Close form and refresh the target tab
    toggleNewEntry();
    await loadSheetData(name);

    // Auto-expand the target tab so the user sees the new entry
    const section = document.getElementById(`tab-${name}`);
    if (section && !section.classList.contains('active')) toggleTab(name);

  } catch(e) {
    toast('Error adding entry: ' + e.message, 'error', 5000);
  }

  btn.disabled = false;
  btn.textContent = '‚úì Add Entry';
}

// ============================================================
//  EDIT MODAL
//  rowIdx: 1-based sheet row number (row 1 = headers, row 2 = first data row)
//  In rawData: rawData[0]=headers, rawData[1]=first data row
//  ‚Üí rawData[rowIdx - 1] maps rowIdx=2 ‚Üí rawData[1] ‚úì
// ============================================================
function openEdit(name, rowIdx) {
  const cfg     = SHEET_CONFIG[name];
  const rawData = appState.sheetData[name];

  // rawData[rowIdx - 1]: rowIdx is 1-based sheet row; subtract 1 for 0-based array
  // rawData[0] = header row ‚Üí rawData[rowIdx - 1] with rowIdx‚â•2 gives a data row ‚úì
  const row = rawData && rawData[rowIdx - 1];
  if (!row) {
    toast('Could not find row data. Please refresh and try again.', 'error');
    return;
  }

  appState.editTarget = { name, rowIdx };
  document.getElementById('edit-modal-title').textContent = `Edit ¬∑ ${name}`;

  const grid = document.getElementById('edit-form-grid');
  grid.innerHTML = cfg.headers.map(function(h, i) {
    const raw   = (row[i] !== undefined && row[i] !== null) ? row[i] : '';
    const id    = `ef_${safeId(h)}`;
    const isWide = (h === 'Remarks' || h === 'Subject/details');
    const spanStyle = '';
    let inputHtml;
    if (h === 'pw') {
      inputHtml = `<input type="text" id="${id}" class="form-input" value="${escAttr(String(raw))}"/>`;
    } else if (h === 'Date') {
      inputHtml = `<input type="date" id="${id}" class="form-input" value="${escAttr(String(raw))}"/>`;
    } else if (h === 'Time') {
      inputHtml = `<input type="time" id="${id}" class="form-input" value="${escAttr(String(raw))}"/>`;
    } else {
      inputHtml = `<input type="text" id="${id}" class="form-input" value="${escAttr(String(raw))}"/>`;
    }
    return `<div class="form-group"${spanStyle}><label class="form-label">${escHtml(h)}</label>${inputHtml}</div>`;
  }).join('');

  document.getElementById('edit-modal').classList.add('open');
}

function closeEditModal() {
  document.getElementById('edit-modal').classList.remove('open');
  appState.editTarget = null;
}

async function submitEdit() {
  if (!appState.editTarget) return;
  const { name, rowIdx } = appState.editTarget;
  const cfg = SHEET_CONFIG[name];
  const btn = document.getElementById('save-edit-btn');

  const row = cfg.headers.map(function(h) {
    const el = document.getElementById(`ef_${safeId(h)}`);
    return el ? el.value.trim() : '';
  });

  btn.disabled = true;
  btn.textContent = 'Saving...';

  try {
    await apiWrite({ action: 'updateRow', sheet: name, rowIndex: rowIdx, row: JSON.stringify(row) });
    toast('Entry updated!', 'success');
    closeEditModal();
    await loadSheetData(name);
  } catch(e) {
    toast('Error updating entry: ' + e.message, 'error', 5000);
  }

  btn.disabled = false;
  btn.textContent = '‚úì Save Changes';
}

// ============================================================
//  DELETE WITH CONFIRMATION
// ============================================================
function confirmDelete(name, rowIdx) {
  document.getElementById('confirm-message').textContent =
    `Delete this entry from "${name}"? This cannot be undone.`;

  // Clone button to remove previous event listeners
  const oldBtn = document.getElementById('confirm-ok-btn');
  const newBtn = oldBtn.cloneNode(true);
  oldBtn.parentNode.replaceChild(newBtn, oldBtn);

  newBtn.addEventListener('click', async function() {
    closeConfirm();
    try {
      await apiWrite({ action: 'deleteRow', sheet: name, rowIndex: rowIdx });
      toast('Entry deleted.', 'success');
      await loadSheetData(name);
    } catch(e) {
      toast('Error deleting entry: ' + e.message, 'error', 5000);
    }
  });

  document.getElementById('confirm-dialog').classList.add('open');
}

function closeConfirm() {
  document.getElementById('confirm-dialog').classList.remove('open');
}

// ============================================================
//  REFRESH ALL DATA
// ============================================================
async function refreshAll() {
  toast('Refreshing data...', 'info');
  // Also refresh cached password
  try {
    const res = await apiGet({ action: 'getPassword' });
    appState.adminPassword = String(res.password);
  } catch(e) { /* non-critical */ }
  await loadAllData();
  toast('Data refreshed!', 'success');
}

// ============================================================
//  INFO POPUP ‚Äî tap any row to view full details
// ============================================================
let infoTarget = null;

function openInfoPopup(name, rowIdx) {
  const cfg     = SHEET_CONFIG[name];
  const rawData = appState.sheetData[name];
  const row     = rawData && rawData[rowIdx - 1];
  if (!row) { toast('Could not load entry data.', 'error'); return; }

  infoTarget = { name, rowIdx };

  // Header
  document.getElementById('info-modal-title').textContent = `Entry ¬∑ Row ${rowIdx - 1}`;
  document.getElementById('info-modal-badge').innerHTML = `${cfg.icon} ${escHtml(name)}`;

  // Build fields
  const fieldsEl = document.getElementById('info-fields');
  fieldsEl.innerHTML = cfg.headers.map(function(h, i) {
    const raw  = (row[i] !== undefined && row[i] !== null) ? String(row[i]) : '';
    const isEmpty = !raw.trim();
    const isLong  = (h === 'Remarks' || h === 'Subject/details');
    const isPw    = (h === 'pw');

    let valHtml;
    if (isEmpty) {
      valHtml = `<span class="info-field-value empty-val">‚Äî empty ‚Äî</span>`;
    } else if (isPw) {
      valHtml = `<span class="info-field-value pw-val" title="Tap to reveal" onclick="this.classList.toggle('revealed')">${escHtml(raw)}</span>`;
    } else if (isLong) {
      valHtml = `<div class="info-field-value long-val">${escHtml(raw)}</div>`;
    } else if (h === 'Date' || h === 'Birthdate') {
      valHtml = `<span class="info-field-value">${escHtml(formatDate(raw))}</span>`;
    } else if (h === 'Time') {
  valHtml = `<span class="info-field-value">${escHtml(formatTime(raw))}</span>`;
} else {
  valHtml = `<span class="info-field-value">${escHtml(raw)}</span>`;
}

    return `<div class="info-field">
      <span class="info-field-label">${escHtml(h)}</span>
      ${valHtml}
    </div>`;
  }).join('');

  document.getElementById('info-modal').classList.add('open');
}

function closeInfoModal() {
  document.getElementById('info-modal').classList.remove('open');
  infoTarget = null;
}

// ============================================================
//  CLOSE MODALS ON OVERLAY CLICK
// ============================================================
document.getElementById('info-modal').addEventListener('click', function(e) {
  if (e.target === this) closeInfoModal();
});
document.getElementById('confirm-dialog').addEventListener('click', function(e) {
  if (e.target === this) closeConfirm();
});
document.getElementById('edit-modal').addEventListener('click', function(e) {
  if (e.target === this) closeEditModal();
});

// ============================================================
//  BOOT ‚Äî run after DOM is fully loaded
// ============================================================
window.addEventListener('DOMContentLoaded', initApp);
</script>
</body>
</html>
